<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Converted Layout</title>
    <link rel="stylesheet" href="/style/layout.css" />
    <link rel="stylesheet" href="/style/tabs.css" />
    <link href="/style/modal.css" rel="stylesheet" />
    <link rel="stylesheet" href="/style/detail-articulo.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="layout">
      <header class="header">
        <nav class="nav">
          <button id="menuToggle" class="menu-toggle">
            <i data-lucide="menu"></i>
          </button>
          <div class="menu-items">
            <!-- Menu items will be dynamically inserted here -->
          </div>
        </nav>
      </header>

      <div class="toolbar">
        <!-- Toolbar icons will be dynamically inserted here -->
      </div>

      <div class="main-content">
        <aside class="sidebar">
          <div class="sidebar-toggle">
            <button id="sidebarToggle">
              <i data-lucide="chevron-left"></i>
            </button>
          </div>
          <nav class="sidebar-nav">
            <!-- Sidebar items will be dynamically inserted here -->
          </nav>
        </aside>
        <main class="content">
          <form id="quoteForm" class="form_container_x92">
            <div class="section_header_k31">Detalle del Artículo</div>
            <div class="form_grid_j84">
              <div class="form-row">
                <div class="form_field_y62">
                  <label class="input_label_m45">Artículo</label>
                  <div class="input-with-button">
                    <input
                      type="text"
                      name="article"
                      class="input_field_p73"
                      readonly
                    />
                    <button type="button">...</button>
                  </div>
                </div>
                <div class="form_field_y62 description-field">
                  <input
                    type="text"
                    name="description"
                    class="input_field_p73"
                    readonly
                  />
                </div>
              </div>
              <br />
              <div class="form-row">
                <div class="form_field_y62">
                  <label class="input_label_m45">Almacen</label>
                  <div class="input-with-button">
                    <input
                      type="text"
                      name="warehouse"
                      class="input_field_p73"
                      readonly
                    />
                    <button type="button">...</button>
                  </div>
                </div>
                <div class="form_field_y62 description-field">
                  <input
                    type="text"
                    name="warehouse_description"
                    class="input_field_p73"
                    readonly
                  />
                </div>
              </div>
              <br />
              <div class="form-row">
                <div class="form_field_y62">
                  <label class="input_label_m45">vendedor</label>
                  <div class="input-with-button">
                    <input
                      type="text"
                      name="vendor"
                      class="input_field_p73"
                      readonly
                    />
                    <button type="button">...</button>
                  </div>
                </div>
                <div class="form_field_y62 description-field">
                  <input
                    type="text"
                    name="vendor_description"
                    class="input_field_p73"
                    readonly
                  />
                </div>
              </div>
              <br />
              <div style="display: flex; flex-direction: row; gap: 5px">
                <div class="form-row">
                  <div class="form_field_y62">
                    <label class="input_label_m45">Modelo</label>
                    <div class="input-with-button">
                      <input
                        type="text"
                        name="model"
                        class="input_field_p73"
                        readonly
                      />
                    </div>
                  </div>
                </div>
                <div class="form_field_y62">
                  <label class="input_label_m45">Marca</label>
                  <input type="text" name="brand" class="input_field_p73" />
                </div>
                <div class="form_field_y62">
                  <label class="input_label_m45">Stock</label>
                  <input
                    type="number"
                    name="stock"
                    value="0"
                    class="input_field_p73 number_input_h28"
                    id="stock"
                  />
                </div>
              </div>
            </div>

            <div class="section_header_k31">Datos de la Venta</div>
            <div class="form_grid_j84">
              <div class="form_field_y62">
                <label class="input_label_m45">Cantidad</label>
                <input
                  type="number"
                  name="quantity"
                  class="input_field_p73 number_input_h28"
                  id="quantity"
                  onchange="calculateTotals()"
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Precio</label>
                <input
                  type="number"
                  name="price"
                  value="0.00"
                  id="price"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  onchange="calculateTotals()"
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Moneda</label>
                <select name="currency" class="input_field_p73">
                  <option value="">Seleccionar moneda</option>
                </select>
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Fch Entrega</label>
                <input
                  type="date"
                  name="delivery_date"
                  class="input_field_p73 date_input_w91"
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Percepción</label>
                <input
                  type="number"
                  name="perception"
                  value="0.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                />
              </div>

              <!--  NEW FIELDS ADDED -->

              <div class="form_field_y62">
                <label class="input_label_m45">Dólares Americanos</label>
                <input
                  type="number"
                  name="amount"
                  value="200.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  id="amount"
                  readonly
                />
              </div>

              <div class="form_field_y62">
                <label class="input_label_m45">% Desc. 1</label>
                <input
                  type="number"
                  name="discount1"
                  value="0"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  id="discount1"
                  onchange="calculateTotals()"
                />
              </div>

              <div class="form_field_y62">
                <label class="input_label_m45">% Desc. 2</label>
                <input
                  type="number"
                  name="discount2"
                  value="0"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  id="discount2"
                  onchange="calculateTotals()"
                />
              </div>

              <div class="form_field_y62">
                <label class="input_label_m45">% Desc. 3</label>
                <input
                  type="number"
                  name="discount3"
                  value="0"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  id="discount3"
                  onchange="calculateTotals()"
                />
              </div>

              <div class="form_field_y62">
                <label class="input_label_m45">Percepción</label>
                <input
                  type="number"
                  name="perception"
                  value="0"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  id="perception"
                  onchange="calculateTotals()"
                />
              </div>

              <div class="form_field_y62">
                <label class="input_label_m45">Bruto:</label>
                <input
                  type="number"
                  id="gross"
                  name="gross"
                  value="200.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  readonly
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Neto:</label>
                <input
                  type="number"
                  id="net"
                  name="net"
                  value="200.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  readonly
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">ISC:</label>
                <input
                  type="number"
                  id="isc"
                  name="isc"
                  value="0.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  readonly
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Impuesto:</label>
                <input
                  type="number"
                  id="tax"
                  name="tax"
                  value="36.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  readonly
                />
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Total Item:</label>
                <input
                  type="number"
                  id="total"
                  name="total"
                  value="236.00"
                  step="0.01"
                  class="input_field_p73 number_input_h28"
                  readonly
                />
              </div>
            </div>

            <div class="section_header_k31">Datos Contables</div>
            <div class="form_grid_j84">
              <div class="form_field_y62">
                <label class="input_label_m45">Cod. Uso</label>
                <select name="usage_code" class="input_field_p73">
                  <option value="">Seleccionar</option>
                </select>
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">C.Costo</label>
                <select name="cost_center" class="input_field_p73">
                  <option value="">AGPOVEN</option>
                </select>
              </div>
              <div class="form_field_y62">
                <label class="input_label_m45">Cod. Proy</label>
                <select name="project_code" class="input_field_p73">
                  <option value="">Seleccionar</option>
                </select>
              </div>
            </div>

            <div class="button_container_v54">
              <button
                type="submit"
                style="background-color: black; color: white; padding: 10px"
                class="button_n37"
              >
                Guardar
              </button>
            </div>
          </form>
        </main>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-item">
            <i data-lucide="home"></i>
            <span>001 EMPRESA DEMO</span>
          </div>
          <div class="footer-item">
            <i data-lucide="user"></i>
            <span>ADM Administrador</span>
          </div>
          <div class="footer-item">
            <i data-lucide="calendar"></i>
            <span>10/12/24</span>
          </div>
          <div class="footer-item">
            <i data-lucide="settings"></i>
            <span>5</span>
          </div>
        </div>
      </footer>
    </div>

    <div id="selectionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Select Value</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <table class="selection-table">
            <thead>
              <tr>
                <th>Code</th>
                <th id="nameHeader" style="display: none">Name</th>
                <th id="stockHeader" style="display: none">Stock</th>
              </tr>
            </thead>
            <tbody id="modalTableBody">
              <!-- Data will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="/js/layout.js"></script>
    <script src="/js/tabs.js"></script>
    <script>
      //   FOR CALCULATING TOTAL PRICE
      function calculateTotals() {
        const quantity =
          parseFloat(document.getElementById("quantity").value) || 0;
        const price = parseFloat(document.getElementById("price").value) || 0;
        const discount1 =
          parseFloat(document.getElementById("discount1").value) || 0;
        const discount2 =
          parseFloat(document.getElementById("discount2").value) || 0;
        const discount3 =
          parseFloat(document.getElementById("discount3").value) || 0;
        const perception =
          parseFloat(document.getElementById("perception").value) || 0;

        // Calculate gross amount (quantity * price)
        const gross = quantity * price;

        // Calculate net amount after discounts
        let net = gross;
        net *= 1 - discount1 / 100;
        net *= 1 - discount2 / 100;
        net *= 1 - discount3 / 100;

        // Calculate tax (18% IGV)
        const tax = net * 0.18;

        // Calculate total
        const total = net + tax + perception;

        // Update display
        document.getElementById("gross").value = gross.toFixed(2);
        document.getElementById("net").value = net.toFixed(2);
        document.getElementById("isc").value = "0.00";
        document.getElementById("tax").value = tax.toFixed(2);
        document.getElementById("total").value = total.toFixed(2);
      }

      // Initial calculation
      calculateTotals();

      const modal = document.getElementById("selectionModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalTableBody = document.getElementById("modalTableBody");
      const closeBtn = document.querySelector(".close");
      const nameHeader = document.getElementById("nameHeader");

      const selectionData = {
        article: [
          { code: "001", name: "Artículo 1" },
          { code: "002", name: "Artículo 2" },
        ],
        warehouse: [
          { code: "002", name: "AG AREQUIPA", stock: 500 },
          { code: "003", name: "AG LIMA", stock: 700 },
        ],
        vendedor: [{ code: "M001" }, { code: "M002" }],
      };

      function openModal(type, inputElement, descriptionElement, stockElement) {
        modalTitle.textContent = `Select ${type}`;
        modalTableBody.innerHTML = "";

        const hasNameData = selectionData[type][0].hasOwnProperty("name");
        const hasStockData = selectionData[type][0].hasOwnProperty("stock");
        nameHeader.style.display = hasNameData ? "table-cell" : "none";
        stockHeader.style.display = hasStockData ? "table-cell" : "none";

        selectionData[type].forEach((item) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${item.code}</td>
                    ${item.name ? `<td>${item.name}</td>` : ""}
                    ${item.stock ? `<td>${item.stock}</td>` : ""}
                `;
          row.onclick = () => {
            inputElement.value = item.code;
            if (descriptionElement) {
              descriptionElement.value = item.name;
            }
            if (stockElement) {
              stockElement.value = item.stock;
            }
            modal.style.display = "none";
          };
          modalTableBody.appendChild(row);
        });

        modal.style.display = "block";
      }

      closeBtn.onclick = () => (modal.style.display = "none");
      window.onclick = (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      document
        .querySelectorAll(".input-with-button button")
        .forEach((button) => {
          button.onclick = (e) => {
            const container = e.target.closest(".form-row");
            const inputElement = container.querySelector("input");
            const label = container
              .querySelector("label")
              .textContent.toLowerCase();
            const descriptionElement = container.querySelector(
              ".description-field input"
            );
            const stockElement = document.getElementById("stock");

            if (label.includes("artículo")) {
              openModal("article", inputElement, descriptionElement);
            } else if (label.includes("almacen")) {
              openModal(
                "warehouse",
                inputElement,
                descriptionElement,
                stockElement
              );
            } else if (label.includes("vendedor")) {
              openModal("vendedor", inputElement, descriptionElement);
            }
          };
        });

      async function fetchData(url, uniqueKey, mapFields) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(
              "Network response was not ok " + response.statusText
            );
          }
          const data = await response.json();
          console.log(data);
          return data.map(mapFields);
        } catch (error) {
          console.error("Error fetching data from:", url, error);
          return [];
        }
      }

      async function fetchSellerData() {
        selectionData.vendedor = await fetchData(
          "http://localhost:3000/vendedores/datos",
          "code",
          (seller) => ({
            code: seller.code,
            name: seller.description,
          })
        );
      }

      fetchSellerData();

      // Form submission handler
      document
        .getElementById("quoteForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const formDataObject = {};
          formDataObject["numero"] = JSON.parse(
            localStorage.getItem("dataLocal")
          ).numero;
          formData.forEach((value, key) => {
            formDataObject[key] = value;
          });

          try {
            const response = await fetch(
              "http://localhost:3000/api/quotes-products",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formDataObject),
              }
            );

            if (!response.ok) {
              throw new Error("Network response was not ok");
            }

            const result = await response.json();
            alert("Quote saved successfully!");
            window.location.href =
              "/transacciones/preventa/cotizaciones/cotizaciones.html";
          } catch (error) {
            console.error("Error:", error);
            alert("Failed to save quote");
          }
        });
    </script>
  </body>
</html>
