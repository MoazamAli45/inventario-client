<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guias de Pedidos </title>
    <link rel="stylesheet" href="/style/layout.css" />
    <link rel="stylesheet" href="/style/tabs.css" />
    <link rel="stylesheet" href="/style/modal.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
       <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      .container-aux {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .section {
        margin-bottom: 20px;
      }

      .section-title {
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
      }
        .btn-print{
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .form-group {
        flex: 1;
        min-width: 200px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #666;
      }
      input {
        height: 30px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .form-group input[type="date"] {
        padding: 6px 8px;
      }

      .full-width {
        width: 100%;
      }

      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        resize: vertical;
        min-height: 60px;
      }

      .buttons {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        padding: 10px;
        border-radius: 4px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-left: 10px;
        font-size: 14px;
      }

      .btn-primary {
        background-color: #000000;
        color: white;
      }

      .btn-secondary {
        background-color: #ffffff;
        color: black;
        border: 1px solid rgb(0, 0, 0, 0.8);
        border-radius: 5px;
      }

      .icon {
        font-size: 14px;
        height: 16px;
        width: 16px;
      }
      .icon-black {
        color: black !important;
      }

      .input-with-button {
        display: flex;
        gap: 5px;
      }

      .input-with-button input {
        flex: 1;
      }

      .input-with-button button {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0 8px;
        cursor: pointer;
      }

      /*  2nd tab content */
      .doc-container * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      .doc-container {
        padding: 20px;
        background-color: #f5f5f5;
      }

      .doc-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .doc-header {
        margin-bottom: 20px;
      }

      .doc-header h2 {
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      .doc-form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .doc-form-group {
        display: flex;
        flex-direction: column;
      }

      .doc-form-group label {
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: #666;
      }

      .doc-form-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .doc-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .doc-tab {
        padding: 8px 16px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 0.9rem;
      }

      .doc-tab.doc-active {
        border-bottom: 2px solid #000;
        font-weight: bold;
      }

      .doc-detail-section {
        margin-bottom: 20px;
      }

      .doc-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .doc-detail-header h3 {
        font-size: 1.1rem;
      }

      .doc-action-buttons {
        display: flex;
        gap: 10px;
      }

      label {
        text-align: left;
      }
      .doc-btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
      }

      .doc-btn-primary {
        background-color: #000;
        color: white;
      }

      .section-title {
        text-align: left;
      }
      .doc-btn-icon {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-items: center;
      }
      .icon {
        height: 16px;
        width: 16px;
      }

      .doc-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .doc-table th {
        text-align: left;
        padding: 10px;
        border-bottom: 2px solid #ddd;
        font-size: 0.9rem;
        color: #666;
      }

      .doc-footer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }


      /*  TABS */
       .tab-button.disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    .tab-content .tab-panel {
      display: none;
    }
    .tab-content .tab-panel.active {
      display: block;
    }
    </style>
  </head>

  <body>
    <div class="layout">
      <header class="header">
        <nav class="nav">
          <button id="menuToggle" class="menu-toggle">
            <i data-lucide="menu"></i>
          </button>
          <div class="menu-items">
            <!-- Menu items will be dynamically inserted here -->
          </div>
        </nav>
      </header>

      <div class="toolbar">
        <!-- Toolbar icons will be dynamically inserted here -->
      </div>

      <div class="main-content">
        <aside class="sidebar">
          <div class="sidebar-toggle">
            <button id="sidebarToggle">
              <i data-lucide="chevron-left"></i>
            </button>
          </div>
          <nav class="sidebar-nav">
            <!-- Sidebar items will be dynamically inserted here -->
          </nav>
        </aside>
        <main class="content">
          <div class="container-aux">
            <h1>
              Guias De Pedidos</h1>
            <div class="container">
              <!-- Tab Navigation -->
              <div class="tabs">
                <button class="tab-button active" id="tabButton1" data-tab="tab1">
                  Datos del Documento
                </button>
                <button class="tab-button " data-tab="tab2" id="tabButton2" >
                  Detalle del Documento
                </button>
                <button class="tab-button" data-tab="tab3">
                  Datos Complementarios
                </button>
                <button class="tab-button" data-tab="tab4">Doc. Anexos</button>
                <button class="tab-button" data-tab="tab5">Lista</button>
              </div>

              <!-- Tab Content -->
              <div class="tab-content">
                <div id="tab1" class="tab-panel active">
                  <div class="container">
                    <div class="section">
                      <div class="section-title">Datos del documento</div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Doc</label>
                          <input type="text" id="docInput" readonly />
                        </div>
                        <div class="form-group">
                            <button id="customButton" class="btn btn-primary">
                            1 2<br />3 4
                          </button>
                        </div>
                        <div class="form-group">
                          <label>Moneda</label>
                          <input
                            type="text"
                           id="monedaInput"
                            readonly
                          />
                        </div>
                         <div class="form-group">
                          <label>Serie</label>
                          <input type="text" id="serieInput" />
                        </div>
                        <div class="form-group">
                          <label>Fch Emisión</label>
                          <input type="date" id="fchInput" />
                        </div>
                      </div>

                      <div class="form-row">
                       
                        <div class="form-group">
                          <label>T. Cambio</label>
                          <input type="text" id="cambioInput" />
                        </div>
                        <div class="form-group">
                          <label>Fch Venc.</label>
                          <input type="date" id="vencInput" />
                        </div>
                      </div>
                   
                      </div>

                   

                      <div class="form-row">
                        <div class="form-group">
                          <label>Número</label>

                           <input type="text" id="uniqueNumber" readonly />
                        </div>
                        <div class="form-group">
                          <label>Almacén</label>
                          <div class="input-with-button">
                            <input type="text"  id="almacenInput" />
                            <button>...</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <input type="text" style="margin-top: 22px" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Prioridad</label>
                          <select name="prioridad">
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Estado</label>
                          <select name="estado">
                            <option value="pendiente">Pendiente</option>
                            <option value="aprobado">Aprobado</option>
                            <option value="rechazado">Rechazado</option>
                          </select>
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Glosa</label>
                          <input type="text" />
                        </div>
                      </div>
                    </div>

                    <div class="section">
                      <div class="section-title">Datos de Cliente</div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Cliente</label>
                          <div class="input-with-button">
                            <input type="text" id="clientInput" />
                            <button>...</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Nombre del Cliente</label>
                          <input type="text" id="nombreInput" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group full-width">
                          <label>Dirección</label>
                          <input
                            type="text"
                         id="address"
                          />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Oper Facil</label>
                          <div class="input-with-button">
                            <input type="text" id="operFacilInput" />
                            <button>...</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Descripción Oper Facil</label>
                          <input type="text"  id="descripciónInput" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Vendedor</label>
                          <div class="input-with-button">
                            <input type="text" id="vendedorInput" />
                            <button>...</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Nombre del Vendedor</label>
                          <input type="text" id="nombreVendedor" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Condición</label>
                          <div class="input-with-button">
                            <input type="text" id="CondiciónInput" />
                            <button>...</button>
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Descripción Condición</label>
                          <input type="text" id="descripciónCondicionInput" />
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label>Reg. Tribut.</label>
                          <input type="text"  id="regNo" />
                        </div>
                        <div class="form-group">
                          <label>Tipo Cond.</label>
                          <input type="text"  id="tipo" />
                        </div>
                      </div>
                    </div>

                    <div class="buttons">

                       <button  class="btn "
                       onclick="window.location.href='/transacciones/facturacion/pending_orders.html'">
                       
                     Pedidos Pendientes
                      </button>
                     
                      <button id="saveButton" class="btn btn-primary">
                      <i data-lucide="Save" class="icon"></i>
                      Guardar
                      </button>
                    </div>
                  </div>
                </div>

                <div id="tab2" class="tab-panel">
                  <!--  DOCUMENTO -->
                  <div class="doc-container">
                    <div class="doc-card">
                      <div class="doc-header">
                        <h2>Documento</h2>
                        <div class="doc-form-row">
                          <div class="doc-form-group">
                            <label>Cliente</label>
                            <input type="text"  readonly  id="customer" />
                          </div>
                          <div class="doc-form-group">
                            <label>&nbsp;</label>
                            <input
                              type="text"
                              readonly
                              id="customerName"
                            />
                          </div><br/>
                          <div class="doc-form-group">
                            <label>Documento</label>
                            <div style="display: flex; gap: 5px">
                              <input
                                type="text"
                                style="width: 60px"
                                readonly
                                id="documentCode"
                              />
                              <input
                                type="text"
                                style="width: 120px"
                                readonly

                                id="documentType"
                              />
                            </div>
                          </div>
                         
                          <div class="doc-form-group">
                            <label>Moneda</label>
                            <div style="display: flex; gap: 5px">
                           
                              <input
                                type="text"
                                value="Dólares Americanos"
                                readonly
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="doc-tabs">
                        <button class="doc-tab doc-active" data-tab="bienes">
                          Bienes
                        </button>
                        <button class="doc-tab" data-tab="servicios">
                          Servicios
                        </button>
                       
                      </div>
                      <div style="overflow-x: auto;" id="product-table"></div>
                      <div class="doc-detail-section">
                        <div id="doc-bienes-section" class="doc-detail-header">
                          <h3>Detalle del Documento - Bienes</h3>
                          
                          <div class="doc-action-buttons">
                            <button class="doc-btn-icon" id="plus-button">
                              <i data-lucide="plus" class="icon"></i>
                            </button>
                            <button class="doc-btn-icon">
                              <i data-lucide="minus" class="icon"></i>
                            </button>
                            <button class="doc-btn-icon">
                              <i data-lucide="file-pen-line" class="icon"></i>
                            </button>
                            <button class="doc-btn-icon">
                              <i data-lucide="file" class="icon"></i>
                            </button>
                          </div>
                        </div>

                        

                        
                      </div>
                      
                      <div class="doc-footer">
                        <div class="doc-form-group">
                          <label>Neto</label>
                          <input type="text" id="neto" readonly />
                        </div>
                        <div class="doc-form-group">
                          <label>ISC</label>
                          <input type="text" id="isc" readonly />
                        </div>
                        <div class="doc-form-group">
                          <label>Impuesto</label>
                          <input type="text" id="tax" readonly />
                        </div>
                        <div class="doc-form-group">
                          <label>Total</label>
                          <input type="text" id="total" readonly />
                        </div>
                        <div class="doc-form-group">
                          <label>Percepción</label>
                          <input type="text" id="perception" readonly />
                        </div>
                      </div>

                      <div class="doc-action-buttons" style="margin-top: 20px">
                        <button class="doc-btn-icon">
                          <i data-lucide="plus" class="icon"></i>
                        </button>
                        <button class="doc-btn-icon">
                          <i data-lucide="minus" class="icon"></i>
                        </button>
 <button class="doc-btn-icon btn-print" id="printButton" >
                              <span>Print</span>
                              <i data-lucide="file" class="icon"></i>
                            </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="tab5" class="tab-panel">

                  <!--  LISTA -->
                    <div class="billing-filter-container">
  <input
    type="text"
    id="billing-filter"
    class="billing-filter-input"
    placeholder="Buscar en todos los campos..."
  />
</div>

<div class="table-main-container">
  <table class="billing-table">
    <thead>
      <tr>
        <th class="billing-table-heading">Código Doc.</th>
        <th class="billing-table-heading">Serie</th>
        <th class="billing-table-heading">Número Doc.</th>
        <th class="billing-table-heading">Fecha Emisión</th>
        <th class="billing-table-heading">Fecha Venc.</th>
        <th class="billing-table-heading">Cliente</th>
        <th class="billing-table-heading">Nombre Cliente</th>
        <th class="billing-table-heading">Dirección</th>
        <th class="billing-table-heading">Vendedor</th>
        <th class="billing-table-heading">Nombre Vendedor</th>
        <th class="billing-table-heading">Almacén</th>
        <th class="billing-table-heading">Moneda</th>
        <th class="billing-table-heading">T.C.</th>
        <th class="billing-table-heading">Prioridad</th>
        <th class="billing-table-heading">Condición</th>
        <th class="billing-table-heading">Desc. Condición</th>
        <th class="billing-table-heading">Tipo Condición</th>
        <th class="billing-table-heading">Reg. Impuesto</th>
        <th class="billing-table-heading">Estado</th>
      </tr>
    </thead>
    <tbody id="billing-data">
      <!-- Data will be inserted here -->
    </tbody>
  </table>
</div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <footer class="footer">
        <div class="footer-content">
          <div class="footer-item">
            <i data-lucide="home"></i>
            <span>001 EMPRESA DEMO</span>
          </div>
          <div class="footer-item">
            <i data-lucide="user"></i>
            <span>ADM Administrador</span>
          </div>
          <div class="footer-item">
            <i data-lucide="calendar"></i>
            <span>10/12/24</span>
          </div>
          <div class="footer-item">
            <i data-lucide="settings"></i>
            <span>5</span>
          </div>
        </div>
      </footer>
    </div>
    <!-- Add this modal HTML right before the closing body tag -->
    <div id="selectionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Select Value</h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <table class="selection-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
              </tr>
            </thead>
            <tbody id="modalTableBody">
              <!-- Data will be dynamically inserted here -->
            </tbody>
          </table>
        </div>
      </div>
     
    </div>

    <!-- Add this script before closing body tag -->
    <script>





// Function to handle tab switching
  function showTab(tabId) {
    const tabPanels = document.querySelectorAll('.tab-panel');
    const tabButtons = document.querySelectorAll('.tab-button');

    tabPanels.forEach(panel => panel.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    tabButtons.forEach(button => button.classList.remove('active'));
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  }

  // Event listener for tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      if (!this.classList.contains('disabled')) {
        showTab(tabId);
      }
    });
  });


      const modal = document.getElementById("selectionModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalTableBody = document.getElementById("modalTableBody");
      const closeBtn = document.querySelector(".close");

      // Sample data for different selection types
      const selectionData = {
        vendor: [],
        operFacil: [],
        condition: [],
        client: [],
        almacen: [
          { code: "001", name: "Almacén 1" },
          { code: "002", name: "Almacén 2" },
        ],     
        //  doc serie
        docSerie: [
          { code: "CO", name: "Cotización" },
          { code: "FA", name: "Factura" },
        ],
      };

      // Function to open modal
      // Function to open modal
function openModal(type, inputElement, descriptionElement,addressElement,regNoElement,typeElement) {
  modalTitle.textContent = `Select ${type}`;
  modalTableBody.innerHTML = "";

  // Clear existing headers and add new ones dynamically
  const thead = modalTableBody.closest("table").querySelector("thead");
  thead.innerHTML = `
    <tr>
      <th>Código</th>
      <th>Nombre</th>
      ${selectionData[type][0].address ? "<th>Dirección</th>" : ""}
      ${selectionData[type][0].type ? "<th>Tipo</th>" : ""}
    </tr>
  `;

  // Populate table rows
  selectionData[type].forEach((item) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.code}</td>
      <td>${item.name}</td>
      ${item.address ? `<td>${item.address}</td>` : ""}
      ${item.type ? `<td>${item.type}</td>` : ""}
    `;
    row.onclick = () => {
      inputElement.value = item.code;
      if (descriptionElement) {
        descriptionElement.value = item.name;
      }
      if (addressElement) {
        addressElement.value = item.address;
      }
      if (regNoElement) {
        regNoElement.value = item.code;
      }
      if(typeElement){
        typeElement.value = item.type;
      }
      modal.style.display = "none";
    };
    modalTableBody.appendChild(row);
  });

  modal.style.display = "block";
}

      // Close modal when clicking the close button or outside the modal
      closeBtn.onclick = () => (modal.style.display = "none");
      window.onclick = (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Add click handlers to all selection buttons
      document
        .querySelectorAll(".input-with-button button")
        .forEach((button) => {
          button.onclick = (e) => {
            const container = e.target.closest(".form-group");
            const inputElement = container.querySelector("input");
            const descriptionElement =
              container.nextElementSibling?.querySelector("input");

              //  ADDRESS FOR CLIENTE
  const addressElement = document.getElementById("address");
  const regNoElement = document.getElementById("regNo");
               
  //   FOR TIPO
  const typeElement = document.getElementById("tipo");
            // Determine which type of selection to show
            if (
              container.querySelector("label").textContent.includes("Cliente")
            ) {
              openModal("client", inputElement, descriptionElement,addressElement,regNoElement);
            } else if (
              container.querySelector("label").textContent.includes("Vendedor")
            ) {
              openModal("vendor", inputElement, descriptionElement);
            } else if (
              container
                .querySelector("label")
                .textContent.includes("Oper Facil")
            ) {
              openModal("operFacil", inputElement, descriptionElement);
            } else if (
              container.querySelector("label").textContent.includes("Condición")
            ) {
              openModal("condition", inputElement, descriptionElement, undefined, undefined,typeElement);
            } else if (
              container.querySelector("label").textContent.includes("Almacén")
            ) {
              openModal("almacen", inputElement, descriptionElement);
            }
          };
        });


//   DOC SERIE
 document.getElementById("customButton").onclick = () => {
                       const documentCode = document.getElementById('docInput');
                        const series = document.getElementById('serieInput');  
                          openModal("docSerie", documentCode,series);
                        };


      //   2nd Documento durther tabs
      const tabs = document.querySelectorAll(".doc-tab");
      const bienesSection = document.getElementById("doc-bienes-section");
      const serviciosSection = document.getElementById("doc-servicios-section");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("doc-active"));
          tab.classList.add("doc-active");

          const activeTab = tab.getAttribute("data-tab");
          if (activeTab === "bienes") {
            bienesSection.style.display = "flex";
            serviciosSection.style.display = "none";
          } else {
            bienesSection.style.display = "none";
            serviciosSection.style.display = "block";
          }
        });
      });

      //    Redirecting to new pagge
      const plusButton = document.getElementById("plus-button");
      plusButton.onclick = () => {
        window.location.href =
          "/transacciones/preventa/cotizaciones/detail-articulo.html";
      };
  

      async function fetchData(url, uniqueKey, mapFields) {
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('Network response was not ok ' + response.statusText);
    }

    const data = await response.json();


    
    return data.map(mapFields);
  } catch (error) {
    console.error('Error fetching data from:', url, error);
    return [];
  }
}

// Fetch and map client data
async function fetchClientData() {
  selectionData.client = await fetchData(
    'http://localhost:3000/clientes/datos',
    'code',
    client => ({
      code: client.code,
      name: client.description,
      address: client.address
    })
  );
}

// Fetch and map seller data
async function fetchSellerData() {
  selectionData.vendor = await fetchData(
    'http://localhost:3000/vendedores/datos',
    'code',
    seller => ({
      code: seller.code,
      name: seller.description
    }) 
  );
}

// Fetch and map operational data
async function fetchOperationalData() {
  selectionData.operFacil = await fetchData(
    'http://localhost:3000/operaciones-facturacion/datos',
    'Code',
    operation => ({
      code: operation.Code,
      name: operation.Description
    })
  );
}

// Fetch and map conditional data
async function fetchConditionalData() {
 
  selectionData.condition = await fetchData(
    'http://localhost:3000/condiciones-comerciales/datos',
    'Code',
    condition => ({
      code: condition.code,
      name: condition.description,
      type: condition.type
    })
  );
}

// Call all fetch functions
fetchClientData();
fetchSellerData();
fetchOperationalData();
fetchConditionalData();

//  GENERATE UNIQUE NUMBER
function generateUniqueNumber() {
    // Generate a random number between 1 and 99999999 and pad with leading zeros
    const uniqueNumber = String(Math.floor(Math.random() * 100000000)).padStart(8, '0');
    document.getElementById('uniqueNumber').value = uniqueNumber;
  }

  // Generate a unique number on page load
  window.onload = generateUniqueNumber;


  document.addEventListener('DOMContentLoaded', function() {
    // Get document number from localStorage
    const documentNumber = localStorage.getItem("selectedDocumentNumber");
    
    if (!documentNumber) {
        console.error("No document number found in localStorage");
        return;
    }

    // Fetch data from API
    fetch(`http://localhost:3000/api/quotes-data-specific?documentNumber=${documentNumber}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.length > 0) {
                const quoteData = data[0];
                
                // Populate form fields and make them readonly
                // Document Data Section
                setReadOnlyValue('docInput', quoteData.documentCode);
                setReadOnlyValue('monedaInput', quoteData.currency);
                setReadOnlyValue('serieInput', quoteData.series);
                setReadOnlyValue('fchInput', quoteData.issueDate);
                setReadOnlyValue('cambioInput', quoteData.exchangeRate);
                setReadOnlyValue('vencInput', quoteData.expiryDate);
                setReadOnlyValue('uniqueNumber', quoteData.documentNumber);
                setReadOnlyValue('almacenInput', quoteData.warehouse);

                // Set select fields and make them disabled
                const prioritySelect = document.querySelector('select[name="prioridad"]');
                const estadoSelect = document.querySelector('select[name="estado"]');
                
                if (prioritySelect) {
                    prioritySelect.value = quoteData.priority;
                    prioritySelect.disabled = true;
                }
                
                if (estadoSelect) {
                    estadoSelect.value = quoteData.status;
                    estadoSelect.disabled = true;
                }

                // Client Data Section
                setReadOnlyValue('clientInput', quoteData.customer);
                setReadOnlyValue('nombreInput', quoteData.customerName);
                setReadOnlyValue('address', quoteData.address);
                setReadOnlyValue('vendedorInput', quoteData.vendor);
                setReadOnlyValue('nombreVendedor', quoteData.vendorName);
                setReadOnlyValue('CondiciónInput', quoteData.conditions);
                setReadOnlyValue('descripciónCondicionInput', quoteData.conditionDescription);
                setReadOnlyValue('regNo', quoteData.taxReg);
                setReadOnlyValue('tipo', quoteData.conditionType);

                setReadOnlyValue('customer', quoteData.customer);
                setReadOnlyValue('customerName', quoteData.customerName);
                setReadOnlyValue('documentCode', quoteData.documentCode);
                setReadOnlyValue('documentType', quoteData.series);

                // Disable all buttons with "..." 
                document.querySelectorAll('.input-with-button button').forEach(button => {
                    button.disabled = true;
                });

                document.getElementById("customButton").disabled=true;

                
            }
        })
        .catch(error => {
            console.error('Error fetching quote data:', error);
        });
});

function setReadOnlyValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.value = value || '';
        element.readOnly = true;
    }
}


//  PRINT DATA
let printData;


function fetchProductData() {
    const selectedDocumentNumber = localStorage.getItem('selectedDocumentNumber');
    
    if (!selectedDocumentNumber) {
        const tableContainers = document.getElementById('product-table');
        tableContainers.innerHTML = `
            <div style="color: red; padding: 20px; text-align: center;">
                No se ha seleccionado ningún número de documento
            </div>
        `;
        
        // Clear input fields
        document.getElementById('neto').value = '0.00';
        document.getElementById('isc').value = '0.00';
        document.getElementById('tax').value = '0.00';
        document.getElementById('perception').value = '0.00';
        document.getElementById('total').value = '0.00';
        return;
    }

    



    const url = `http://localhost:3000/api/quotes-products?numbers=${selectedDocumentNumber}`;
    const tableContainers = document.getElementById('product-table');

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data || data.length === 0) {
                tableContainers.innerHTML = `
                    <div style="color: red; padding: 20px; text-align: center;">
                        No se encontraron registros
                    </div>
                `;
                
                // Clear input fields when no records found
                document.getElementById('neto').value = '0.00';
                document.getElementById('isc').value = '0.00';
                document.getElementById('tax').value = '0.00';
                document.getElementById('perception').value = '0.00';
                document.getElementById('total').value = '0.00';
                return;
            }

            // Calculate sums
            const sums = {
                net: 0,
                isc: 0,
                tax: 0,
                perception: 0
            };

            data.forEach(item => {
                sums.net += Number(item.net) || 0;
                sums.isc += Number(item.isc) || 0;
                sums.tax += Number(item.tax) || 0;
                sums.perception += Number(item.perception) || 0;
            });


            printData=data;

            document.getElementById('neto').value = sums.net.toFixed(2);
            document.getElementById('isc').value = sums.isc.toFixed(2);
            document.getElementById('tax').value = sums.tax.toFixed(2);
            document.getElementById('perception').value = sums.perception.toFixed(2);
            document.getElementById('total').value = (sums.net + sums.isc + sums.tax + sums.perception).toFixed(2);

            // Create table element
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '20px';

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headers = Object.keys(data[0] || {});
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText.charAt(0).toUpperCase() + headerText.slice(1);
                th.style.padding = '12px';
                th.style.backgroundColor = '#f2f2f2';
                th.style.borderBottom = '2px solid #ddd';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                headers.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = item[header];
                    cell.style.padding = '12px';
                    cell.style.borderBottom = '1px solid #ddd';
                    row.appendChild(cell);
                });
                
                row.addEventListener('mouseover', () => {
                    row.style.backgroundColor = '#f5f5f5';
                });
                
                row.addEventListener('mouseout', () => {
                    row.style.backgroundColor = '';
                });
                
                tbody.appendChild(row);
            });

            // Add totals row
            const totalsRow = document.createElement('tr');
            headers.forEach(header => {
                const cell = document.createElement('td');
                if (['net', 'isc', 'tax', 'perception'].includes(header)) {
                    cell.textContent = sums[header].toFixed(2);
                    cell.style.fontWeight = 'bold';
                }
                cell.style.padding = '12px';
                cell.style.borderBottom = '1px solid #ddd';
                cell.style.backgroundColor = '#f2f2f2';
                totalsRow.appendChild(cell);
            });
            tbody.appendChild(totalsRow);
            
            table.appendChild(tbody);
            
            tableContainers.innerHTML = '';
            tableContainers.appendChild(table);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            
            tableContainers.innerHTML = `
                <div style="color: red; padding: 20px; text-align: center;">
                    Error al cargar los datos: ${error.message}
                </div>
            `;
            
            // Clear input fields on error
            document.getElementById('neto').value = '0.00';
            document.getElementById('isc').value = '0.00';
            document.getElementById('tax').value = '0.00';
            document.getElementById('perception').value = '0.00';
            document.getElementById('total').value = '0.00';
        });
}
fetchProductData()

//  GET Print
const printButton=document.getElementById('printButton');
printButton.addEventListener('click',()=>{

  console.log(printData,"Print")

  const dataLocalStorage=JSON.parse(localStorage.getItem('dataLocal'));
  console.log(dataLocalStorage,"LOCAL",printData);
 generatePdfInvoice(printData);
})


    function generatePdfInvoice(data) {
const jsPDF = window.jspdf.jsPDF;

const doc = new jsPDF();

// Document title and other details
doc.setFontSize(18);
doc.setFont('helvetica', 'bold');
doc.text('Pedidos', 140, 20);
doc.setFontSize(12);
doc.text(` ${JSON.parse(localStorage.getItem('dataLocal')).numero}`, 140, 28);

// Customer and Contact Information
const localData = JSON.parse(localStorage.getItem('dataLocal'));
doc.setFont('helvetica', 'normal');
doc.setFontSize(10);
doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 35);
doc.text(`Cliente: ${localData.customerName}`, 20, 42);
doc.text(`RUC: ${localData.customer}`, 20, 49);
doc.text(`Documento: ${localData.documentCode} ${localData.series}-${localData.numero}`, 20, 56);

// Table headers
let yPos = 70;
const headers = ['Artículo', 'Descripción', 'Cantidad', 'Precio Unitario', 'Subtotal'];
const columnWidths = [30, 80, 30, 30, 30];

headers.forEach((header, index) => {
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(header, 20 + columnWidths.slice(0, index).reduce((a, b) => a + b, 0), yPos);
});

yPos += 8;

// Add table data
const productData = data ;// Renamed from 'data' to 'productData'
const sums = { net: 0, isc: 0, tax: 0, perception: 0 };

productData.forEach(item => {
  const row = [
    item.article,
    item.description,
    item.quantity,
    item.price.toFixed(2),
    (item.quantity * item.price).toFixed(2)
  ];

  row.forEach((text, index) => {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(String(text), 20 + columnWidths.slice(0, index).reduce((a, b) => a + b, 0), yPos);
  });
  
  // Calculate sums
  sums.net += Number(item.net) || 0;
  sums.isc += Number(item.isc) || 0;
  sums.tax += Number(item.tax) || 0;
  sums.perception += Number(item.perception) || 0;

  yPos += 8;
});

// Totals section
const grandTotal = sums.net + sums.isc + sums.tax + sums.perception;

yPos += 10;
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.text('Total Neto:', 140, yPos);
doc.text(sums.net.toFixed(2), 180, yPos);
yPos += 8;
doc.text('ISC:', 140, yPos);
doc.text(sums.isc.toFixed(2), 180, yPos);
yPos += 8;
doc.text('IGV (Impuesto):', 140, yPos);
doc.text(sums.tax.toFixed(2), 180, yPos);
yPos += 8;
doc.text('Percepción:', 140, yPos);
doc.text(sums.perception.toFixed(2), 180, yPos);
yPos += 8;
doc.text('Total a Pagar:', 140, yPos);
doc.text(grandTotal.toFixed(2), 180, yPos);

// Save the PDF
doc.save(`cotizacion_${localData.numero}.pdf`);

    }





  document.getElementById("saveButton").addEventListener("click", updateQuoteState);

  function updateQuoteState() {
    const documentNumber = localStorage.getItem("selectedDocumentNumber");

    if (!documentNumber) {
      alert("Please first select the pending quote");
      return;
    }

    const url = "http://localhost:3000/api/quotes-data"; // Update this URL if your endpoint is different
    const data = {
      documentNumber: documentNumber,
      state: 'guide'
    };

    fetch(url, {
      method: "PUT", // Use PUT for updates
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then(data => {
      alert('El pedido se convierte en guía.servicios'); 
      localStorage.removeItem("selectedDocumentNumber");
      window.location.href = "/transacciones/facturacion/guias-de-pedidos.html";
    })
    .catch(error => {
      console.error("Error updating data:", error);
      alert("Error updating data.");
    });
  }



  
//  LISTA TAB

// DOM Elements
const filterInput = document.getElementById('billing-filter');
const billingData = document.getElementById('billing-data');
const tableContainer = document.querySelector('.table-main-container');

// Global variables
let allQuotesData = [];

// Main function to fetch and display data
async function fetchAndDisplayQuotes() {
  try {
    // Show loading state
    billingData.innerHTML = `
      <tr>
        <td colspan="19" style="text-align: center;">
          <div class="loading-spinner"></div>
          Cargando datos...
        </td>
      </tr>
    `;

    // Fetch data from API
    const response = await fetch('http://localhost:3000/api/orders-data');
   
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
 
    
    // Store data globally for filtering
    allQuotesData = data;

    // Display the data
    displayQuotes(data);
    
    // Setup filter functionality
    setupFilter();

  } catch (error) {
    console.error('Error fetching data:', error);
    billingData.innerHTML = `
      <tr>
        <td colspan="19" style="text-align: center; color: #dc3545;">
          Error al cargar los datos. Por favor, intente nuevamente.
        </td>
      </tr>
    `;
  }
}

// Function to display quotes
function displayQuotes(quotes) {
  if (!quotes.length) {
    billingData.innerHTML = `
      <tr>
        <td colspan="19" style="text-align: center;">
          No se encontraron registros
        </td>
      </tr>
    `;
    return;
  }

  billingData.innerHTML = quotes.map(quote => `
    <tr>
      <td>${sanitizeHTML(quote.documentCode) || ''}</td>
      <td>${sanitizeHTML(quote.series) || ''}</td>
      <td>${sanitizeHTML(quote.documentNumber) || ''}</td>
      <td>${formatDate(quote.issueDate)}</td>
      <td>${formatDate(quote.expiryDate)}</td>
      <td>${sanitizeHTML(quote.customer) || ''}</td>
      <td>${sanitizeHTML(quote.customerName) || ''}</td>
      <td>${sanitizeHTML(quote.address) || ''}</td>
      <td>${sanitizeHTML(quote.vendor) || ''}</td>
      <td>${sanitizeHTML(quote.vendorName) || ''}</td>
      <td>${sanitizeHTML(quote.warehouse) || ''}</td>
      <td>${formatCurrency(quote.currency)}</td>
      <td>${formatNumber(quote.exchangeRate)}</td>
      <td>${formatPriority(quote.priority)}</td>
      <td>${sanitizeHTML(quote.conditions) || ''}</td>
      <td>${sanitizeHTML(quote.conditionDescription) || ''}</td>
      <td>${sanitizeHTML(quote.conditionType) || ''}</td>
      <td>${sanitizeHTML(quote.taxReg) || ''}</td>
      <td>${getStatusBadge(quote.status)}</td>
    </tr>
  `).join('');
}

// Setup filter functionality
function setupFilter() {
  filterInput.addEventListener('input', debounce((e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    if (!searchTerm) {
      displayQuotes(allQuotesData);
      return;
    }

    const filteredData = allQuotesData.filter(quote => 
      Object.entries(quote).some(([key, value]) => {
        // Skip null values and non-searchable fields
        if (value === null || value === undefined) return false;
        if (key === 'id' || key === 'createdAt' || key === 'updatedAt') return false;
        
        return String(value).toLowerCase().includes(searchTerm);
      })
    );
    
    displayQuotes(filteredData);
  }, 300));
}

// Helper Functions
function sanitizeHTML(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('es-PE', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

function formatNumber(number) {
  if (!number) return '';
  return Number(number).toLocaleString('es-PE', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function formatCurrency(currency) {
  const currencies = {
    'PEN': 'Soles',
    'USD': 'Dólares',
    'EUR': 'Euros',
    'GBP': 'Libras'
  };
  return currencies[currency] || currency || '';
}

function formatPriority(priority) {
  const priorities = {
    'HIGH': 'Alta',
    'MEDIUM': 'Media',
    'LOW': 'Baja'
  };
  return priorities[priority?.toUpperCase()] || priority || '';
}

function getStatusBadge(status) {
  if (!status) return '';
  
  const statusMap = {
    'ACTIVE': { class: 'status-active', text: 'Activo' },
    'PENDING': { class: 'status-pending', text: 'Pendiente' },
    'CANCELLED': { class: 'status-cancelled', text: 'Cancelado' },
    'COMPLETED': { class: 'status-completed', text: 'Completado' }
  };

  const statusKey = status.toUpperCase();
  const statusInfo = statusMap[statusKey] || { class: 'status-default', text: status };

  return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
}

// Debounce function for search optimization
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Add CSS Styles
const style = document.createElement('style');
style.textContent = `
  .billing-filter-container {
    margin: 20px 0;
  }

  .billing-filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
  }

  .table-main-container {
    overflow-x: auto;
    max-height: 70vh;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }

  .billing-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .billing-table th,
  .billing-table td {
    padding: 12px 8px;
    text-align: left;
    border: 1px solid #dee2e6;
    white-space: nowrap;
  }

  .billing-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .billing-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
  }

  .billing-table tbody tr:hover {
    background-color: #f2f2f2;
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
    display: inline-block;
    text-align: center;
  }

  .status-active {
    background-color: #e6f4ea;
    color: #1e7e34;
  }

  .status-pending {
    background-color: #fff3e0;
    color: #f57c00;
  }

  .status-cancelled {
    background-color: #fdecea;
    color: #dc3545;
  }

  .status-completed {
    background-color: #e3f2fd;
    color: #0d47a1;
  }

  .status-default {
    background-color: #e9ecef;
    color: #495057;
  }

  .loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);
document.addEventListener('DOMContentLoaded', fetchAndDisplayQuotes);

    </script>

    <script src="/js/layout.js"></script>
    <script src="/js/tabs.js"></script>
  </body>
</html>
